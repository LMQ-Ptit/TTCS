extends ../../layouts/default.pug
block main
    // Breadcrumb navigation
    .bg-light.py-3.mb-4
        .container
            nav(aria-label="breadcrumb")
                ol.breadcrumb.mb-0
                    li.breadcrumb-item
                        a.text-decoration-none(href="/") Trang chủ
                    li.breadcrumb-item
                        a.text-decoration-none(href="/cart") Giỏ hàng
                    li.breadcrumb-item.active(aria-current="page") Lịch sử đơn hàng

    .container
        // Thông báo alert
        if messages.error || messages.success
            .row.mb-4
                .col-12
                    if messages.error
                        .alert.alert-danger.alert-dismissible.fade.show.position-relative.shadow-sm.border-0.rounded-3
                            i.fas.fa-exclamation-circle.me-2
                            | #{messages.error}
                            button.btn-close(type="button" data-bs-dismiss="alert")
                            .progress.position-absolute.bottom-0.start-0.end-0.rounded-0(style="height: 4px;")
                                .progress-bar.bg-danger.progress-bar-striped.progress-countdown(role="progressbar", style="width: 100%")
                    if messages.success
                        .alert.alert-success.alert-dismissible.fade.show.position-relative.shadow-sm.border-0.rounded-3
                            i.fas.fa-check-circle.me-2
                            | #{messages.success}
                            button.btn-close(type="button" data-bs-dismiss="alert")
                            .progress.position-absolute.bottom-0.start-0.end-0.rounded-0(style="height: 4px;")
                                .progress-bar.bg-success.progress-bar-striped.progress-countdown(role="progressbar", style="width: 100%")

    .container.py-4
        .row.mb-4
            .col-12
                .d-flex.justify-content-between.align-items-center
                    h2.text-primary.mb-0
                        i.fas.fa-history.me-2
                        | Lịch sử đơn hàng
                    .d-flex.gap-2
                        a.btn.btn-outline-primary(href="/cart")
                            i.fas.fa-shopping-cart.me-2
                            | Giỏ hàng
                        a.btn.btn-outline-secondary.d-none.d-md-inline-block(href="/products")
                            i.fas.fa-arrow-left.me-2
                            | Tiếp tục mua sắm

        if(cart.product.length > 0)
            // Card cho các đơn hàng
            .card.border-0.shadow-sm.rounded-4.mb-4
                .card-header.bg-white.border-0.py-3
                    .d-flex.justify-content-between.align-items-center
                        h5.mb-0.fw-bold Đơn hàng gần đây (#{cart.product.length})
                        .order-status.badge.bg-primary.rounded-pill Đã hoàn thành
                
                .card-body.p-0
                    .table-responsive
                        table.table.table-hover.align-middle.mb-0
                            thead.bg-light
                                tr
                                    th.ps-4(width="5%") STT
                                    th(width="15%") Ảnh
                                    th(width="30%") Sản phẩm
                                    th.text-end(width="15%") Đơn giá
                                    th.text-center(width="15%") Số lượng
                                    th.text-end.pe-4(width="20%") Thành tiền
                            tbody
                                each item, index in cart.product
                                    tr.product-history-row
                                        td.ps-4 #{index + 1}
                                        td
                                            a(href=`/products/${item.productInfo.slug}`)
                                                img.rounded.shadow-sm(
                                                    src=item.productInfo.thumbnail
                                                    alt=item.productInfo.title
                                                    style="width: 70px; height: 70px; object-fit: cover;"
                                                )
                                        td
                                            a.text-decoration-none.text-dark.fw-medium(href=`/products/${item.productInfo.slug}`)
                                                | #{item.productInfo.title}
                                            if item.productInfo.discountPercentage > 0
                                                .badge.bg-danger.mt-2
                                                    i.fas.fa-tag.me-1
                                                    | -#{item.productInfo.discountPercentage}%
                                        td.text-end
                                            .price-current.text-danger.fw-bold #{new Intl.NumberFormat('vi-VN').format(item.productInfo.priceNew)}₫
                                            if item.productInfo.price > item.productInfo.priceNew
                                                .price-old.text-muted.text-decoration-line-through.small #{new Intl.NumberFormat('vi-VN').format(item.productInfo.price)}₫
                                        td.text-center
                                            span.badge.bg-light.text-dark.border #{item.quantity}
                                        td.text-end.fw-bold.pe-4 #{new Intl.NumberFormat('vi-VN').format(item.totalPrice)}₫
                
                .card-footer.bg-white.py-3
                    .row
                        .col-md-6
                            .order-date
                                i.far.fa-calendar-alt.me-2.text-muted
                                span.text-muted Ngày đặt hàng: 
                                span.fw-medium 01/05/2023
                        .col-md-6.text-md-end
                            .order-total
                                span.text-muted Tổng tiền:
                                span.h5.ms-2.text-danger.mb-0 #{new Intl.NumberFormat('vi-VN').format(cart.totalPrice)}₫
            
            // Các nút hành động
            .d-flex.justify-content-center.gap-3.mt-4
                a.btn.btn-primary(href="/cart")
                    i.fas.fa-shopping-cart.me-2
                    | Quay lại giỏ hàng
                a.btn.btn-success(href="/products")
                    i.fas.fa-shopping-bag.me-2
                    | Tiếp tục mua sắm
        else
            .card.shadow-sm.text-center.py-5.border-0.rounded-4
                .my-5.py-5
                    i.fas.fa-history.fa-4x.text-muted.mb-4
                    h3.text-primary.mb-3 Chưa có lịch sử đơn hàng
                    p.text-muted.mb-4 Bạn chưa có đơn hàng nào trong lịch sử gần đây
                    .d-flex.justify-content-center.gap-2
                        a.btn.btn-primary.px-4(href="/products")
                            i.fas.fa-shopping-bag.me-2
                            | Mua sắm ngay
                        a.btn.btn-outline-secondary.px-4(href="/cart")
                            i.fas.fa-shopping-cart.me-2
                            | Giỏ hàng của tôi

    style.
        /* Product row styling */
        .product-history-row {
            transition: background-color 0.2s;
        }
        
        .product-history-row:hover {
            background-color: rgba(0,0,0,0.01);
        }
        
        /* Status badge styling */
        .order-status {
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
        }
        
        /* Progress bar animation */
        .progress-countdown {
            animation: progressAnimation 3s linear;
        }
        
        @keyframes progressAnimation {
            from { width: 100%; }
            to { width: 0%; }
        }
        
        /* Order item info */
        .order-date,
        .order-total {
            padding: 0.5rem 0;
        }
        
        @media (max-width: 767.98px) {
            .table-responsive {
                border-radius: 0;
            }
        }

    script.
        // Xử lý tự động tắt alert
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            const duration = 3000; // 3 giây
            const interval = 50; // Cập nhật mỗi 50ms
            
            alerts.forEach(function(alert) {
                const progressBar = alert.querySelector('.progress-countdown');
                let timeLeft = duration;
                let timer;
                
                timer = setInterval(function() {
                    timeLeft -= interval;
                    const percentage = (timeLeft / duration) * 100;
                    
                    progressBar.style.width = percentage + '%';
                    
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, interval);
                
                alert.addEventListener('mouseenter', function() {
                    clearInterval(timer);
                });
                
                alert.addEventListener('mouseleave', function() {
                    timeLeft = Math.max(1000, timeLeft);
                    
                    timer = setInterval(function() {
                        timeLeft -= interval;
                        const percentage = (timeLeft / duration) * 100;
                        progressBar.style.width = percentage + '%';
                        
                        if (timeLeft <= 0) {
                            clearInterval(timer);
                            const bsAlert = new bootstrap.Alert(alert);
                            bsAlert.close();
                        }
                    }, interval);
                });
            });
        });