extends ../../layouts/default.pug

block main
    .container.py-5
        .row
            // Sidebar điều hướng
            .col-lg-3.mb-4.mb-lg-0
                .account-sidebar.card.border-0.shadow-sm.rounded-4.overflow-hidden
                    .card-header.bg-primary.text-white.p-4
                        .d-flex.align-items-center
                            .account-avatar.position-relative
                                if user.avatar
                                    img.rounded-circle.border.border-3.border-white.shadow(
                                        src=user.avatar
                                        alt="Avatar"
                                        style="width: 60px; height: 60px; object-fit: cover;"
                                    )
                                else
                                    img.rounded-circle.border.border-3.border-white.shadow(
                                        src='https://ui-avatars.com/api/?name='+user.fullName+'&background=random&color=fff'
                                        alt="Avatar"
                                        style="width: 60px; height: 60px; object-fit: cover;"
                                    )
                            .ms-3
                                h5.mb-0.fw-bold #{user.fullName}
                                p.text-white-50.mb-0 #{user.email}

                    .list-group.list-group-flush
                        a.list-group-item.list-group-item-action.active.d-flex.align-items-center(href="/user/info")
                            i.fas.fa-user-circle.fa-fw.me-3
                            | Thông tin tài khoản
                        a.list-group-item.list-group-item-action.active.d-flex.align-items-center(href="/user/edit")
                            i.fas.fa-edit.fa-fw.me-3
                            | Chỉnh sửa thông tin
                        a.list-group-item.list-group-item-action.d-flex.align-items-center(href="/cart")
                            i.fas.fa-shopping-bag.fa-fw.me-3
                            | Đơn hàng của tôi
                        a.list-group-item.list-group-item-action.d-flex.align-items-center(href="/cart/history")
                            i.fas.fa-heart.fa-fw.me-3
                            | Lịch sử mua hàng
                        a.list-group-item.list-group-item-action.d-flex.align-items-center(href="/user/logout")
                            i.fas.fa-sign-out-alt.fa-fw.me-3
                            | Đăng xuất

            // Nội dung chính
            .col-lg-9
                // Thông báo
                if messages.error || messages.success
                    if messages.error
                        .alert.alert-danger.alert-dismissible.fade.show.position-relative.mb-4
                            i.fas.fa-exclamation-circle.me-2
                            | #{messages.error}
                            button.btn-close(type="button" data-bs-dismiss="alert")
                            .progress.position-absolute.bottom-0.start-0.end-0.rounded-0(style="height: 4px;")
                                .progress-bar.bg-danger.progress-bar-striped.progress-countdown(role="progressbar", style="width: 100%")
                    if messages.success
                        .alert.alert-success.alert-dismissible.fade.show.position-relative.mb-4
                            i.fas.fa-check-circle.me-2
                            | #{messages.success}
                            button.btn-close(type="button" data-bs-dismiss="alert")
                            .progress.position-absolute.bottom-0.start-0.end-0.rounded-0(style="height: 4px;")
                                .progress-bar.bg-success.progress-bar-striped.progress-countdown(role="progressbar", style="width: 100%")
                
                // Card chỉnh sửa thông tin
                .card.border-0.shadow-sm.rounded-4.overflow-hidden
                    .card-header.bg-gradient.border-0.py-3
                        h3.mb-0.text-primary
                            i.fas.fa-edit.me-2
                            | Chỉnh sửa thông tin cá nhân

                    .card-body.p-4
                        form(action="/user/edit?_method=PATCH", method="POST")
                            .row.mb-4.align-items-center
                                .col-lg-4.text-center.mb-4.mb-lg-0
                                    .avatar-container.position-relative.mx-auto.mb-3
                                        if user.avatar
                                            img.rounded-circle.shadow.img-thumbnail.p-0.border-0.preview-avatar(
                                                src=user.avatar
                                                alt="Avatar"
                                                style="width: 150px; height: 150px; object-fit: cover;"
                                            )
                                        else
                                            img.rounded-circle.shadow.img-thumbnail.p-0.border-0.preview-avatar(
                                                src='https://ui-avatars.com/api/?name='+user.fullName+'&background=random&color=fff&size=150'
                                                alt="Avatar"
                                                style="width: 150px; height: 150px; object-fit: cover;"
                                            )
                                    
                                    .mb-3
                                        .input-group
                                            input#avatarUrl.form-control(
                                                type="url"
                                                name="avatar"
                                                placeholder="Nhập URL hình ảnh"
                                                value=user.avatar || ""
                                            )
                                            
                                    
                                    .text-muted.small Nhập URL hình ảnh từ internet (http://, https://)


                                .col-lg-8
                                    .form-container.bg-light.rounded-4.p-4
                                        h5.text-primary.border-bottom.pb-2.mb-3
                                            i.fas.fa-info-circle.me-2
                                            | Thông tin cơ bản

                                        .mb-3
                                            label.form-label(for="fullName")
                                                i.fas.fa-user.me-2
                                                | Họ và tên
                                                span.text-danger *
                                            input#fullName.form-control(
                                                type="text"
                                                name="fullName"
                                                required
                                                placeholder="Nhập họ và tên"
                                                value=user.fullName
                                            )
                                            .form-text.text-muted Họ tên đầy đủ của bạn

                                        .mb-3
                                            label.form-label(for="email")
                                                i.fas.fa-envelope.me-2
                                                | Email
                                                span.text-danger *
                                            .input-group
                                                input#email.form-control(
                                                    type="email"
                                                    name="email"
                                                    required
                                                    placeholder="Nhập email"
                                                    value=user.email
                                                    readonly=(user.status === "active")
                                                )
                                                if user.status === "active"
                                                    .input-group-text.bg-success.text-white
                                                        i.fas.fa-check-circle.me-1
                                                        | Đã xác thực
                                            .form-text.text-muted
                                                if user.status === "active"
                                                    | Email đã được xác thực không thể thay đổi
                                                else
                                                    | Email dùng để đăng nhập và nhận thông báo

                                        .mb-3
                                            label.form-label(for="phone")
                                                i.fas.fa-phone.me-2
                                                | Số điện thoại
                                            input#phone.form-control(
                                                type="tel"
                                                name="phone"
                                                placeholder="Nhập số điện thoại"
                                                value=user.phone || ""
                                            )
                                            .form-text.text-muted Số điện thoại dùng để liên hệ và nhận thông báo đơn hàng
                                        
                                        

                            .d-flex.justify-content-end.mt-4.gap-2
                                a.btn.btn-outline-secondary.px-4(href="/user/info")
                                    i.fas.fa-times.me-2
                                    | Hủy
                                button.btn.btn-primary.px-4(type="submit")
                                    i.fas.fa-save.me-2
                                    | Lưu thay đổi

    style.
        .bg-gradient {
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
        }
        
        .avatar-container {
            width: 150px;
            height: 150px;
            overflow: hidden;
            margin: 0 auto;
        }
        
        .list-group-item.active {
            background-color: #f8f9fa;
            color: #0d6efd;
            border-color: #dee2e6;
            font-weight: 600;
        }
        
        .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

    script.
        // Xử lý tự động tắt alert
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            const duration = 3000; // 3 giây
            const interval = 50; // Cập nhật mỗi 50ms
            
            alerts.forEach(function(alert) {
                const progressBar = alert.querySelector('.progress-countdown');
                let timeLeft = duration;
                let timer;
                
                timer = setInterval(function() {
                    timeLeft -= interval;
                    const percentage = (timeLeft / duration) * 100;
                    progressBar.style.width = percentage + '%';
                    
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, interval);
                
                alert.addEventListener('mouseenter', function() {
                    clearInterval(timer);
                });
                
                alert.addEventListener('mouseleave', function() {
                    timeLeft = Math.max(1000, timeLeft);
                    
                    timer = setInterval(function() {
                        timeLeft -= interval;
                        const percentage = (timeLeft / duration) * 100;
                        progressBar.style.width = percentage + '%';
                        
                        if (timeLeft <= 0) {
                            clearInterval(timer);
                            const bsAlert = new bootstrap.Alert(alert);
                            bsAlert.close();
                        }
                    }, interval);
                });
            });
            
            // Xử lý xem trước ảnh đại diện khi chọn file
            const avatarInput = document.getElementById('avatar');
            const previewAvatar = document.querySelector('.preview-avatar');
            
            if (avatarInput && previewAvatar) {
                avatarInput.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            previewAvatar.src = e.target.result;
                        }
                        
                        reader.readAsDataURL(this.files[0]);
                    }
                });
            }
        });